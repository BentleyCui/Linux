## 线程的基本概念

LWP： light weight process 轻量级的进程，本质仍是进程(在 Linux 环境下)  

**进程**

独立地址空间，拥有 PCB  

**线程**

有独立的 PCB，但没有独立的地址空间(共享)  

**区别：**是否共享地址空间。  

![image](https://user-images.githubusercontent.com/59153788/168845898-f1251474-024d-40b9-b64e-cf2194b689a7.png)

线程是最小的执行单位

进程是最小分配资源的单位

```shell
ps -Lf 进程id
查看线程号 LWP,cpu执行的最小单位
```

​    

## Linux内核线程实现原理

1. 轻量级进程(light-weight process)，也有 PCB，创建线程使用的底层函数和进一样，都是 clone  
2. 从内核里看进程和线程是一样的，都有各自不同的 PCB，但是 PCB 中指向内存源的三级页表是相同的 
3. 进程可以蜕变成线程
4. 线程可看做寄存器和栈的集合     

三级映射：进程 PCB --> 页目录(可看成数组，首地址位于 PCB 中) --> 页表 --> 物理页面 --> 内存单元  

对于进程来说，相同的地址(同一个虚拟地址)在不同的进程中，反复使用而不冲突。原因是他们虽虚拟址一样，但，页目录、页表、物理页面各不相同。相同的虚拟址，射到不同的物理页面内存单元，最终访问不同的物理页面。

但！线程不同！两个线程具有各自独立的 PCB，但共享同一个页目录，也就共享同一个页表和物理页面。所以两个 PCB 共享一个地址空间。

实际上，无论是创建进程的 fork，还是创建线程的 pthread_create，底层实现都是调用同一个内核函数 clone。  

**Linux 内核是不区分进程和线程的。只在用户层面上进行区分。所以，线程所有操作函数 pthread_* 是库函数，而非系统调用。  **


